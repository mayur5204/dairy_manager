{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}{% if form.instance.id %}Edit{% else %}Add{% endif %} Sale - Dairy Manager{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus-circle{% endif %} text-primary"></i>
        {% if form.instance.pk %}Edit{% else %}Add{% endif %} Sale
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'sale_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to List
            </a>
            <a href="{% url 'sale_batch_input' %}" class="btn btn-sm btn-accent">
                <i class="fas fa-th"></i> Batch Input
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">{% if form.instance.id %}Edit{% else %}Add{% endif %} Sale</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            {{ form.customer|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.date|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            {{ form.milk_type|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.quantity|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12">
                            {{ form.notes|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="mt-4 text-end">
                        <a href="{% url 'sale_list' %}" class="btn btn-outline-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">
                            {% if form.instance.id %}Update{% else %}Save{% endif %} Sale
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const customerSelect = document.getElementById('id_customer');
        const milkTypeSelect = document.getElementById('id_milk_type');
        
        // Function to load all milk types
        function loadAllMilkTypes() {
            if (customerSelect.value) {
                // Only load milk types when a customer is selected
                milkTypeSelect.disabled = false;
                
                // Clear current options
                milkTypeSelect.innerHTML = '<option value="">---------</option>';
                
                // Fetch all milk types
                fetch(`{% url 'get_all_milk_types' %}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log("All milk types:", data);
                        if (data.milk_types && data.milk_types.length > 0) {
                            // Add all milk types
                            data.milk_types.forEach(milkType => {
                                const option = document.createElement('option');
                                option.value = milkType.id;
                                option.textContent = milkType.name;
                                milkTypeSelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => {
                        console.error("Failed to fetch milk types:", error);
                        milkTypeSelect.innerHTML = '<option value="">Error loading milk types</option>';
                    });
            } else {
                // No customer selected, reset milk type field
                milkTypeSelect.innerHTML = '<option value="">---------</option>';
                milkTypeSelect.disabled = true;
            }
        }
        
        // Load milk types when customer selection changes
        if (customerSelect) {
            customerSelect.addEventListener('change', loadAllMilkTypes);
            
            // Initialize on page load
            if (customerSelect.value) {
                loadAllMilkTypes();
            }
        }
    });
</script>
{% endblock %}
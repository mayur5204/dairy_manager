{% extends 'base.html' %}
{% load dict_filters %}
{% load i18n %}

{% block title %}{% trans "Customers - Dairy Manager" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-users text-primary"></i> {% trans "Customers" %}</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'customer_add' %}" class="btn btn-sm btn-primary">
                <i class="fas fa-plus-circle"></i> {% trans "Add Customer" %}
            </a>
        </div>
    </div>
</div>

<!-- Enhanced Search Bar with Area Filter -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3 align-items-end">
            <div class="col-md-6">
                <label for="searchInput" class="form-label"><i class="fas fa-search"></i> {% trans "Search Customer" %}</label>
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" name="search" id="searchInput" class="form-control form-control-lg" 
                           placeholder="{% trans 'Search by customer name...' %}" value="{{ search_query }}" autofocus>
                    {% if search_query %}
                    <button id="clearSearch" class="btn btn-outline-secondary">
                        <i class="fas fa-times"></i> {% trans "Clear" %}
                    </button>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-4">
                <label for="areaFilter" class="form-label"><i class="fas fa-map-marker-alt"></i> {% trans "Filter by Area" %}</label>
                <select id="areaFilter" class="form-select form-select-lg">
                    <option value="">{% trans "All Areas" %}</option>
                    {% for area in areas %}
                    <option value="{{ area.id }}" {% if selected_area == area.id %}selected{% endif %}>{{ area.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2">
                <span id="searchSpinner" class="d-none">
                    <i class="fas fa-spinner fa-spin"></i> {% trans "Searching..." %}
                </span>
            </div>
        </div>
    </div>
</div>

<style>
    .milk-delivery-badge {
        background-color: #81c784 !important; /* Green background for badges */
        color: #1b5e20 !important; /* Dark green text for better contrast */
    }
    
    .milk-delivery-no-data {
        background-color: #f5f5f5 !important;
        color: #757575 !important;
    }
    
    /* Pagination styles */
    .page-link {
        color: #198754;
    }
    
    .page-item.active .page-link {
        background-color: #198754;
        border-color: #198754;
    }
    
    .page-link:focus {
        box-shadow: 0 0 0 0.25rem rgba(25, 135, 84, 0.25);
    }
    
    /* Search highlighting styles */
    .search-highlight {
        background-color: #fff59d;
        padding: 0 2px;
        border-radius: 2px;
        font-weight: bold;
    }
</style>

<div class="card">
    <div class="card-header">
        <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">{% trans "Customer List" %}</h5>
            <div class="d-flex align-items-center">
                <span class="badge bg-primary me-2">{{ current_month }}</span>
                {% if total_customers %}
                <span class="badge bg-secondary">{% trans "Total" %}: {{ total_customers }} {% trans "customers" %}</span>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>{% trans "Sr.No." %}</th>
                        <th>{% trans "Name" %}</th>
                        <th>{% trans "Milk Types" %}</th>
                        <th>{% trans "Total Milk Delivered" %} ({{ current_month }})</th>
                        <th>{% trans "Balance" %} (₹)</th>
                        <th>{% trans "Actions" %}</th>
                    </tr>
                </thead>
                <tbody id="customerTableBody">
                    {% for customer in customers %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>
                            <a href="{% url 'customer_detail' customer.id %}" class="text-decoration-none">
                            {% if search_query and customer.highlighted_name %}
                                {{ customer.highlighted_name|safe }}
                            {% else %}
                                {{ customer.name }}
                            {% endif %}
                            </a>
                        </td>
                        <td>
                            {% for milk_type in customer.milk_types.all %}
                            <span class="badge bg-success">{{ milk_type.name }}</span>
                            {% empty %}
                            <span class="badge bg-light text-dark">{% trans "None" %}</span>
                            {% endfor %}
                        </td>
                        <td>
                            {% with customer_delivery=customer_data|get_item:customer.id|get_item:'milk_delivery' %}
                                {% if customer_delivery %}
                                    {% for milk_type_name, quantity in customer_delivery.items %}
                                        <span class="badge milk-delivery-badge">
                                            {{ milk_type_name }}: {{ quantity|floatformat:1 }} {% trans "L" %}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="badge milk-delivery-no-data">{% trans "No deliveries" %}</span>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td>
                            {% with balance=customer_data|get_item:customer.id|get_item:'balance' %}
                                <span class="badge {% if balance > 0 %}bg-success{% elif balance < 0 %}bg-danger{% else %}bg-light text-dark{% endif %} fs-6">
                                    ₹{{ balance|floatformat:2 }}
                                </span>
                            {% endwith %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="{% url 'sale_add' %}?customer={{ customer.id }}" class="btn btn-primary">
                                    <i class="fas fa-plus-circle"></i> {% trans "Sale" %}
                                </a>
                                <a href="{% url 'payment_add' %}?customer={{ customer.id }}" class="btn btn-accent">
                                    <i class="fas fa-money-bill"></i> {% trans "Payment" %}
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination controls -->
        {% if is_paginated %}
        <div class="d-flex justify-content-center mt-4">
            <nav aria-label="Customer pagination">
                <ul class="pagination pagination-ajax">
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link" href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_area %}&area={{ selected_area }}{% endif %}" aria-label="First">
                            <span aria-hidden="true">&laquo;&laquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_area %}&area={{ selected_area }}{% endif %}" aria-label="Previous">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    {% endif %}
                    
                    {% for page_num in page_range %}
                        {% if page_num == "..." %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% else %}
                            <li class="page-item {% if page_obj.number == page_num %}active{% endif %}">
                                <a class="page-link" href="?page={{ page_num }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_area %}&area={{ selected_area }}{% endif %}">{{ page_num }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_area %}&area={{ selected_area }}{% endif %}" aria-label="Next">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    <li class="page-item">
                        <a class="page-link" href="?page={{ paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if selected_area %}&area={{ selected_area }}{% endif %}" aria-label="Last">
                            <span aria-hidden="true">&raquo;&raquo;</span>
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        <div class="text-center text-muted small">
            {% trans "Showing" %} {{ page_obj.start_index }}-{{ page_obj.end_index }} {% trans "of" %} {{ paginator.count }} {% trans "customers" %}
        </div>
        {% endif %}
        
        <div id="noResultsMessage" class="text-center py-5 d-none">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <p class="lead">{% trans "No customers found" %}</p>
            <p class="text-muted">{% trans "No customers match your search" %}: "<span id="searchQueryText"></span>"</p>
            <button id="clearSearchBtn" class="btn btn-secondary">
                <i class="fas fa-times"></i> {% trans "Clear Search" %}
            </button>
        </div>
        {% if not customers %}
        <div class="text-center py-5">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <p class="lead">{% trans "No customers found" %}</p>
            <p class="text-muted">{% trans "Add customers to start recording sales and payments" %}</p>
            <a href="{% url 'customer_add' %}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> {% trans "Add Customer" %}
            </a>
        </div>
        {% endif %}
    </div>
</div>

<script>
// Debounce function to limit how often the search is triggered
function debounce(func, wait) {
    let timeout;
    return function() {
        const context = this;
        const args = arguments;
        clearTimeout(timeout);
        timeout = setTimeout(() => {
            func.apply(context, args);
        }, wait);
    };
}

// When the DOM is fully loaded
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const clearSearchBtn = document.getElementById('clearSearchBtn');
    const customerTableBody = document.getElementById('customerTableBody');
    const noResultsMessage = document.getElementById('noResultsMessage');
    const searchQueryText = document.getElementById('searchQueryText');
    const searchSpinner = document.getElementById('searchSpinner');
    
    // Function to perform the search via AJAX
    const performSearch = debounce(function(refreshSearch = false) {
        const searchTerm = searchInput.value.trim();
        
        // If search term is empty, do a full page reload to restore pagination
        if (!searchTerm) {
            window.location.href = window.location.pathname;
            return;
        }
        
        // Show spinner while searching
        searchSpinner.classList.remove('d-none');
        
        // Set the current URL with the search parameter to enable browser history
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('search', searchTerm);
        
        // Preserve area filter if it exists
        const areaFilter = document.getElementById('areaFilter');
        if (areaFilter && areaFilter.value) {
            currentUrl.searchParams.set('area', areaFilter.value);
        } else {
            currentUrl.searchParams.delete('area');
        }
        
        // Remove page parameter when searching to start from page 1
        currentUrl.searchParams.delete('page');
        
        // Update the URL for browser history, but don't include ajax_search in the URL
        history.replaceState(null, '', currentUrl.toString());
        
        // Add ajax_search parameter only to the fetch request
        const fetchUrl = new URL(currentUrl);
        fetchUrl.searchParams.set('ajax_search', 'true');
        
        // Add a timestamp to prevent caching when using back button
        if (refreshSearch) {
            fetchUrl.searchParams.set('_', Date.now());
        }
        
        // Make the AJAX request with the ajax_search parameter
        fetch(fetchUrl.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            // Prevent caching when using back button
            cache: 'no-store'
        })
        .then(response => response.json())
        .then(data => {
            // Hide spinner
            searchSpinner.classList.add('d-none');
            
            // Hide pagination when showing search results
            const paginationElements = document.querySelectorAll('.pagination, .text-center.text-muted.small');
            paginationElements.forEach(el => {
                el.style.display = 'none';
            });
            
            if (data.customers && data.customers.length > 0) {
                // We have results
                noResultsMessage.classList.add('d-none');
                customerTableBody.classList.remove('d-none');
                
                // Clear existing rows
                customerTableBody.innerHTML = '';
                
                // Add new rows with dynamic link behavior
                data.customers.forEach(customer => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${customer.counter}</td>
                        <td>
                            <a href="/dairy/customers/${customer.id}/" class="text-decoration-none">
                                ${customer.highlighted_name || customer.name}
                            </a>
                        </td>
                        <td>${customer.milk_types_html}</td>
                        <td>${customer.delivery_html.replace(/bg-info text-dark/g, 'milk-delivery-badge').replace(/bg-light text-dark">No deliveries/g, 'milk-delivery-no-data">No deliveries')}</td>
                        <td>${customer.balance_html}</td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a href="/dairy/sales/add/?customer=${customer.id}" class="btn btn-primary">
                                    <i class="fas fa-plus-circle"></i> {% trans "Sale" %}
                                </a>
                                <a href="/dairy/payments/add/?customer=${customer.id}" class="btn btn-accent">
                                    <i class="fas fa-money-bill"></i> {% trans "Payment" %}
                                </a>
                            </div>
                        </td>
                    `;
                    customerTableBody.appendChild(row);
                });
                
                // Show the total count of search results
                const totalCountEl = document.createElement('div');
                totalCountEl.className = 'text-center text-muted small mt-3';
                totalCountEl.innerHTML = `{% trans "Showing all" %} ${data.total_count} {% trans "matching customers" %}`;
                const cardBody = customerTableBody.closest('.card-body');
                const existingTotalCount = cardBody.querySelector('.text-center.text-muted.small:not(.pagination + .text-center)');
                if (existingTotalCount) {
                    existingTotalCount.remove();
                }
                cardBody.appendChild(totalCountEl);
                
            } else {
                // No results
                customerTableBody.classList.add('d-none');
                noResultsMessage.classList.remove('d-none');
                searchQueryText.textContent = searchTerm;
            }
        })
        .catch(error => {
            console.error('Error fetching search results:', error);
            searchSpinner.classList.add('d-none');
        });
    }, 300); // 300ms delay
    
    // Initialize search and area filter based on URL parameters (important for back button navigation)
    function initSearchFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const searchParam = urlParams.get('search');
        const areaParam = urlParams.get('area');
        
        // Initialize search if parameter exists
        if (searchParam) {
            searchInput.value = searchParam;
            performSearch(true);  // Force refresh to avoid caching issues
        }
        
        // Initialize area filter if parameter exists
        if (areaParam && areaFilter) {
            areaFilter.value = areaParam;
        }
    }
    
    // Handle browser navigation events (back/forward buttons)
    window.addEventListener('popstate', function() {
        initSearchFromUrl();
    });
    
    // Submit the search when input changes
    searchInput.addEventListener('input', function() {
        if (this.value.trim()) {
            performSearch(true);
        } else {
            // If search input is cleared, update the URL but keep area filter if present
            const areaFilter = document.getElementById('areaFilter');
            const areaValue = areaFilter ? areaFilter.value : '';
            
            let url = window.location.pathname;
            if (areaValue) {
                url += '?area=' + areaValue;
            }
            window.location.href = url;
        }
    });
    
    // Handle area filter changes asynchronously
    const areaFilter = document.getElementById('areaFilter');
    if (areaFilter) {
        areaFilter.addEventListener('change', function() {
            // Show spinner while filtering
            searchSpinner.classList.remove('d-none');
            
            // Get the current search value
            const searchValue = searchInput.value.trim();
            
            // Update URL for browser history without refreshing page
            const currentUrl = new URL(window.location.href);
            const searchParams = currentUrl.searchParams;
            
            if (this.value) {
                searchParams.set('area', this.value);
            } else {
                searchParams.delete('area');
            }
            
            if (searchValue) {
                searchParams.set('search', searchValue);
            } else {
                searchParams.delete('search');
            }
            
            // Reset to page 1 when filtering
            searchParams.delete('page');
            
            // Update browser URL without reloading
            history.pushState({}, '', currentUrl.toString());
            
            // Add ajax_search parameter for fetch request
            const fetchUrl = new URL(currentUrl);
            fetchUrl.searchParams.set('ajax_search', 'true');
            
            // Fetch results
            fetch(fetchUrl.toString(), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                cache: 'no-store'
            })
            .then(response => response.json())
            .then(data => {
                // Hide spinner
                searchSpinner.classList.add('d-none');
                
                // Hide pagination when showing filtered results
                const paginationElements = document.querySelectorAll('.pagination, .text-center.text-muted.small');
                paginationElements.forEach(el => {
                    el.style.display = 'none';
                });
                
                if (data.customers && data.customers.length > 0) {
                    // We have results
                    noResultsMessage.classList.add('d-none');
                    customerTableBody.classList.remove('d-none');
                    
                    // Clear existing rows
                    customerTableBody.innerHTML = '';
                    
                    // Add new rows
                    data.customers.forEach(customer => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${customer.counter}</td>
                            <td>
                                <a href="/dairy/customers/${customer.id}/" class="text-decoration-none">
                                    ${customer.highlighted_name || customer.name}
                                </a>
                            </td>
                            <td>${customer.milk_types_html}</td>
                            <td>${customer.delivery_html.replace(/bg-info text-dark/g, 'milk-delivery-badge').replace(/bg-light text-dark">No deliveries/g, 'milk-delivery-no-data">No deliveries')}</td>
                            <td>${customer.balance_html}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="/dairy/sales/add/?customer=${customer.id}" class="btn btn-primary">
                                        <i class="fas fa-plus-circle"></i> {% trans "Sale" %}
                                    </a>
                                    <a href="/dairy/payments/add/?customer=${customer.id}" class="btn btn-accent">
                                        <i class="fas fa-money-bill"></i> {% trans "Payment" %}
                                    </a>
                                </div>
                            </td>
                        `;
                        customerTableBody.appendChild(row);
                    });
                    
                    // Show the total count of results
                    const totalCountEl = document.createElement('div');
                    totalCountEl.className = 'text-center text-muted small mt-3';
                    totalCountEl.innerHTML = `{% trans "Showing all" %} ${data.total_count} {% trans "matching customers" %}`;
                    const cardBody = customerTableBody.closest('.card-body');
                    const existingTotalCount = cardBody.querySelector('.text-center.text-muted.small:not(.pagination + .text-center)');
                    if (existingTotalCount) {
                        existingTotalCount.remove();
                    }
                    cardBody.appendChild(totalCountEl);
                    
                } else {
                    // No results
                    customerTableBody.classList.add('d-none');
                    noResultsMessage.classList.remove('d-none');
                    searchQueryText.textContent = searchValue || 'area filter';
                }
            })
            .catch(error => {
                console.error('Error fetching filtered results:', error);
                searchSpinner.classList.add('d-none');
            });
        });
    }
    
    // Clear button functionality
    const clearSearchFunction = function(e) {
        if (e) e.preventDefault();
        searchInput.value = '';
        
        // Keep area filter if it's set
        const areaFilter = document.getElementById('areaFilter');
        let url = window.location.pathname;
        
        if (areaFilter && areaFilter.value) {
            url += '?area=' + areaFilter.value;
        }
        
        // Do a full page reload to restore pagination instead of AJAX search
        window.location.href = url;
    };
    
    if (clearSearch) {
        clearSearch.addEventListener('click', clearSearchFunction);
    }
    
    if (clearSearchBtn) {
        clearSearchBtn.addEventListener('click', clearSearchFunction);
    }
    
    // Handle pagination with AJAX
    document.addEventListener('click', function(e) {
        // Check if clicked element is a pagination link
        if (e.target.closest('.pagination-ajax a.page-link')) {
            e.preventDefault();
            
            const link = e.target.closest('.pagination-ajax a.page-link');
            const url = new URL(link.href);
            
            // Show spinner
            searchSpinner.classList.remove('d-none');
            
            // Add AJAX parameter
            url.searchParams.set('ajax_search', 'true');
            
            // Fetch page data
            fetch(url.toString(), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                cache: 'no-store'
            })
            .then(response => response.json())
            .then(data => {
                // Hide spinner
                searchSpinner.classList.add('d-none');
                
                if (data.customers && data.customers.length > 0) {
                    // Update customer table with new data
                    customerTableBody.innerHTML = '';
                    
                    data.customers.forEach(customer => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${customer.counter}</td>
                            <td>
                                <a href="/dairy/customers/${customer.id}/" class="text-decoration-none">
                                    ${customer.highlighted_name || customer.name}
                                </a>
                            </td>
                            <td>${customer.milk_types_html}</td>
                            <td>${customer.delivery_html.replace(/bg-info text-dark/g, 'milk-delivery-badge').replace(/bg-light text-dark">No deliveries/g, 'milk-delivery-no-data">No deliveries')}</td>
                            <td>${customer.balance_html}</td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <a href="/dairy/sales/add/?customer=${customer.id}" class="btn btn-primary">
                                        <i class="fas fa-plus-circle"></i> {% trans "Sale" %}
                                    </a>
                                    <a href="/dairy/payments/add/?customer=${customer.id}" class="btn btn-accent">
                                        <i class="fas fa-money-bill"></i> {% trans "Payment" %}
                                    </a>
                                </div>
                            </td>
                        `;
                        customerTableBody.appendChild(row);
                    });
                    
                    // Update URL for browser history without reloading
                    history.pushState({}, '', link.href);
                }
            })
            .catch(error => {
                console.error('Error fetching page:', error);
                searchSpinner.classList.add('d-none');
            });
            
            return false;
        }
    });
    
    // Run initial search if URL contains search parameter
    initSearchFromUrl();
    
    // Focus the search input on page load
    searchInput.focus();
});
</script>

{% if link_type %}
<script>
    document.querySelector('body').setAttribute('data-link-type', '{{ link_type }}');
</script>
{% endif %}
{% endblock %}
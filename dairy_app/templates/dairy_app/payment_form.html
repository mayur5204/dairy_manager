{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}

{% block title %}{% if form.instance.pk %}{% trans "Edit" %}{% else %}{% trans "Add" %}{% endif %} {% trans "Payment" %} - {% trans "Dairy Manager" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus-circle{% endif %} text-primary"></i>
        {% if form.instance.pk %}{% trans "Edit" %}{% else %}{% trans "Add" %}{% endif %} {% trans "Payment" %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'payment_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Back to List" %}
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                {% if not customer and not from_customer_page %}
                <!-- Customer Search Section -->
                <div class="mb-4">
                    <h5>{% trans "Search Customer" %}</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="{% trans "Enter customer name..." %}" id="customerSearch">
                        <button class="btn btn-outline-secondary" type="button" onclick="window.location.href='{% url 'payment_add' %}'">
                            <i class="fas fa-times"></i> {% trans "Clear" %}
                        </button>
                    </div>
                    
                    {% if search_results %}
                    <div class="list-group">
                        {% for result in search_results %}
                        <a href="{% url 'payment_add' %}?customer={{ result.id }}" class="list-group-item list-group-item-action">
                            {{ result.name }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <form method="post">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            {% if from_customer_page or customer %}
                                <div id="div_id_customer" class="mb-3">
                                    <label class="form-label">{% trans "Customer" %}</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" value="{{ customer.name }}" readonly>
                                        <input type="hidden" name="customer" value="{{ customer.id }}">
                                        <a href="{% url 'payment_add' %}" class="btn btn-outline-secondary">
                                            <i class="fas fa-times"></i> {% trans "Change" %}
                                        </a>
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {{ form.date|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            {{ form.amount|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.description|as_crispy_field }}
                        </div>
                    </div>
                    
                    <div class="mt-4 text-end">
                        <a href="{% url 'payment_list' %}" class="btn btn-outline-secondary">{% trans "Cancel" %}</a>
                        <button type="submit" class="btn btn-primary">
                            {% if form.instance.pk %}{% trans "Update" %}{% else %}{% trans "Save" %}{% endif %} {% trans "Payment" %}
                        </button>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerSearch = document.getElementById('customerSearch');
    if (customerSearch) {
        customerSearch.addEventListener('input', debounce(function() {
            const searchTerm = this.value.trim();
            if (searchTerm) {
                window.location.href = `{% url 'payment_add' %}?search=${encodeURIComponent(searchTerm)}`;
            }
        }, 500));
    }
});

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}
</script>
{% endblock %}
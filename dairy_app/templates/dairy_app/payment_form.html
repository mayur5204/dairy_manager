{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load i18n %}
{% load dict_filters %}

{% block title %}{% if form.instance.pk %}{% trans "Edit" %}{% else %}{% trans "Add" %}{% endif %} {% trans "Payment" %} - {% trans "Dairy Manager" %}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-{% if form.instance.pk %}edit{% else %}plus-circle{% endif %} text-primary"></i>
        {% if form.instance.pk %}{% trans "Edit" %}{% else %}{% trans "Add" %}{% endif %} {% trans "Payment" %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            {% if from_customer_page and customer %}
            <a href="{% url 'customer_detail' customer.id %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Back to Customer" %}
            </a>
            {% else %}
            <a href="{% url 'payment_list' %}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> {% trans "Back to List" %}
            </a>
            {% endif %}
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-body">
                {% if not customer and not from_customer_page %}
                <!-- Customer Search Section -->
                <div class="mb-4">
                    <h5>{% trans "Search Customer" %}</h5>
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" placeholder="{% trans "Enter customer name..." %}" id="customerSearch">
                        <button class="btn btn-outline-secondary" type="button" onclick="window.location.href='{% url 'payment_add' %}'">
                            <i class="fas fa-times"></i> {% trans "Clear" %}
                        </button>
                    </div>
                    
                    {% if search_results %}
                    <div class="list-group">
                        {% for result in search_results %}
                        <a href="{% url 'payment_add' %}?customer={{ result.id }}" class="list-group-item list-group-item-action">
                            {{ result.name }}
                        </a>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- Hidden field to preserve return destination -->
                    {% if return_to %}
                    <input type="hidden" name="return" value="{{ return_to }}">
                    {% endif %}
                    
                    <!-- Show customer info when coming from customer page -->
                    {% if from_customer_page and customer %}
                    <div class="alert alert-info d-flex align-items-center mb-3" role="alert">
                        <i class="fas fa-user me-2"></i>
                        <div>
                            <strong>{% trans "Recording payment for:" %}</strong> {{ customer.name }}
                            {% if customer.area %}<br><small class="text-muted">{{ customer.area.name }}</small>{% endif %}
                        </div>
                    </div>
                    {{ form.customer.as_hidden }}
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            {% if not from_customer_page and not customer %}
                                {{ form.customer|as_crispy_field }}
                            {% else %}
                                {{ form.date|as_crispy_field }}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if not from_customer_page and not customer %}
                                {{ form.date|as_crispy_field }}
                            {% else %}
                                {{ form.amount|as_crispy_field }}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            {% if not from_customer_page and not customer %}
                                {{ form.amount|as_crispy_field }}
                            {% else %}
                                {{ form.description|as_crispy_field }}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if not from_customer_page and not customer %}
                                {{ form.description|as_crispy_field }}
                            {% else %}
                                {{ form.payment_for_month|as_crispy_field }}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            {% if not from_customer_page and not customer %}
                                {{ form.payment_for_month|as_crispy_field }}
                            {% else %}
                                {{ form.payment_for_year|as_crispy_field }}
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            {% if not from_customer_page and not customer %}
                                {{ form.payment_for_year|as_crispy_field }}
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-2 single-month-info">
                        <i class="fas fa-info-circle"></i> {% trans "Please specify which month and year this payment is for. This helps track payment status for each month." %}
                    </div>
                    
                    <!-- Multi-month payment option -->
                    <div class="row">
                        <div class="col-12">
                            {{ form.is_multi_month|as_crispy_field }}
                        </div>
                    </div>
                    
                    <!-- Show existing allocations for multi-month payments when editing -->
                    {% if form.instance.pk and is_multi_month_payment %}
                    <div class="alert alert-info mt-2 existing-allocations-info">
                        <h6><i class="fas fa-info-circle"></i> {% trans "Current Payment Allocations" %}</h6>
                        <p class="mb-2">{% trans "This payment is currently distributed across the following months:" %}</p>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>{% trans "Month" %}</th>
                                        <th>{% trans "Amount" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for allocation in existing_allocations %}
                                    <tr>
                                        <td>{{ allocation.month|month_name }} {{ allocation.year }}</td>
                                        <td>₹{{ allocation.amount|floatformat:2 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <th>{% trans "Total" %}</th>
                                        <th>₹{{ form.instance.amount|floatformat:2 }}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <p class="mt-2 mb-0">
                            <small class="text-muted">
                                <strong>{% trans "To edit this payment:" %}</strong><br>
                                • {% trans "Change the amount above if needed" %}<br>
                                • {% trans "Check 'Distribute across multiple months' below to change which months receive the payment" %}<br>
                                • {% trans "Select the new months you want to allocate to" %}<br>
                                • {% trans "The system will automatically redistribute the (possibly new) amount across your selected months" %}
                            </small>
                        </p>
                    </div>
                    {% endif %}
                    
                    <div class="alert alert-warning mt-2 multi-month-info" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i> {% trans "When distributing across multiple months, the payment will be allocated to the selected months only. The month and year selectors above will be ignored." %}
                    </div>
                    
                    <div id="unpaid-months-section" class="mt-3" style="display: none;">
                        <div class="card">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">{% trans "Select Months to Pay" %}</h5>
                            </div>
                            <div class="card-body">
                                <p class="card-text">{% trans "Select which months to allocate this payment to. The payment will be distributed starting from oldest unpaid month." %}</p>
                                
                                <div id="unpaid-months-content">
                                    {% if form.unpaid_months %}
                                    {% if form.instance.pk %}
                                    <div class="alert alert-info mb-3">
                                        <i class="fas fa-info-circle"></i> 
                                        {% trans "Months highlighted in yellow are currently allocated to this payment. You can modify the selection and click 'Update Payment' to redistribute the amount." %}
                                    </div>
                                    {% endif %}
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>{% trans "Select" %}</th>
                                                    <th>{% trans "Month" %}</th>
                                                    <th>{% trans "Sales Amount" %}</th>
                                                    <th>{% trans "Paid Amount" %}</th>
                                                    <th>{% trans "Remaining" %}</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for month in form.unpaid_months %}
                                                <tr{% if month.is_currently_allocated %} class="table-warning"{% endif %}>
                                                    <td>
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" name="selected_months" value="{{ month.month }}_{{ month.year }}" id="month-{{ month.month }}-{{ month.year }}"{% if month.is_currently_allocated %} checked{% endif %}>
                                                        </div>
                                                    </td>
                                                    <td>
                                                        {{ month.month_name }} {{ month.year }}
                                                        {% if month.is_currently_allocated %}
                                                            <span class="badge bg-warning text-dark ms-1" title="{% trans 'Currently allocated to this payment' %}">{% trans "Current" %}</span>
                                                        {% endif %}
                                                    </td>
                                                    <td>₹{{ month.sales_amount|floatformat:2 }}</td>
                                                    <td>₹{{ month.payment_amount|floatformat:2 }}</td>
                                                    <td>₹{{ month.remaining|floatformat:2 }}</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        <div class="text-end mt-2">
                                            <button type="button" class="btn btn-sm btn-primary refresh-unpaid-months" data-customer-id="{{ customer.id }}">
                                                <i class="fas fa-sync-alt"></i> {% trans "Refresh Months" %}
                                            </button>
                                        </div>
                                    </div>
                                    {% else %}
                                    <div class="alert alert-secondary">
                                        {% if customer %}
                                            {% trans "No unpaid months found for this customer. All months have been paid or no sales records exist yet." %}
                                            <button type="button" class="btn btn-sm btn-outline-primary ms-2 refresh-unpaid-months" data-customer-id="{{ customer.id }}">
                                                <i class="fas fa-sync-alt"></i> {% trans "Check Again" %}
                                            </button>
                                        {% else %}
                                            {% trans "No unpaid months found. Please select a customer first." %}
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-end">
                        {% if from_customer_page and customer %}
                        <a href="{% url 'customer_detail' customer.id %}" class="btn btn-outline-secondary">{% trans "Cancel" %}</a>
                        {% else %}
                        <a href="{% url 'payment_list' %}" class="btn btn-outline-secondary">{% trans "Cancel" %}</a>
                        {% endif %}
                        <button type="submit" class="btn btn-primary">
                            {% if form.instance.pk %}{% trans "Update" %}{% else %}{% trans "Save" %}{% endif %} {% trans "Payment" %}
                        </button>
                    </div>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Add jQuery here since it's not in base template -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const customerSearch = document.getElementById('customerSearch');
    if (customerSearch) {
        customerSearch.addEventListener('input', debounce(function() {
            const searchTerm = this.value.trim();
            if (searchTerm) {
                window.location.href = `{% url 'payment_add' %}?search=${encodeURIComponent(searchTerm)}`;
            }
        }, 500));
    }
});

function debounce(func, wait) {
    let timeout;
    return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), wait);
    };
}

// Show/hide unpaid months section based on multi-month checkbox
$(document).ready(function() {
    // Function to refresh the unpaid months table
    function refreshUnpaidMonths(customerId) {
        if (!customerId) {
            return;
        }
        
        // Show loading indicator inside the content area
        $('#unpaid-months-content').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">{% trans "Loading..." %}</span>
                </div>
                <p class="mt-2">{% trans "Loading unpaid months..." %}</p>
            </div>
        `);
        
        // Make sure the section is visible
        $('#unpaid-months-section').show();
        
        // Make an AJAX request to fetch unpaid months
        $.ajax({
            url: window.location.href,
            method: 'GET',
            data: {
                customer: customerId,
                fetch_unpaid: true,
                timestamp: new Date().getTime() // Cache buster
            },
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                // For AJAX requests, the response is already the content we need
                if (typeof response === 'string') {
                    // If it's a string response (from the partial template), use it directly
                    $('#unpaid-months-content').html(response);
                } else {
                    // Fallback: try to parse as HTML and extract content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(response, 'text/html');
                    
                    // Check if we have any content in the response
                    if (doc && doc.querySelector('#unpaid-months-content')) {
                        $('#unpaid-months-content').html(doc.querySelector('#unpaid-months-content').innerHTML);
                    } else {
                        // If we can't find the content, try to use the whole response
                        $('#unpaid-months-content').html(response);
                    }
                }
                
                // Select all checkboxes
                $('input[name="selected_months"]').prop('checked', true);
                
                // Show a success message if there are unpaid months
                if ($('input[name="selected_months"]').length > 0) {
                    // Remove any previous messages
                    $('#unpaid-months-message').remove();
                    
                    // Add a success message
                    $('<div id="unpaid-months-message" class="alert alert-success mt-2 mb-0">' +
                      '<i class="fas fa-check-circle"></i> ' +
                      '{% trans "Unpaid months loaded successfully." %}' +
                      '</div>').insertAfter('#unpaid-months-content');
                    
                    // Auto-hide the message after 5 seconds
                    setTimeout(() => {
                        $('#unpaid-months-message').fadeOut();
                    }, 5000);
                }
            },
            error: function(xhr, status, error) {
                // Store customer ID in a data attribute for the refresh button
                const customerId = $('input[name="customer"]').val();
                $('#unpaid-months-content').html(`
                    <div class="alert alert-danger">
                        {% trans "Failed to load unpaid months. Please try again." %}
                        <button class="btn btn-sm btn-outline-danger ms-2 refresh-unpaid-months" data-customer-id="${customerId}">
                            <i class="fas fa-sync-alt"></i> {% trans "Try Again" %}
                        </button>
                    </div>
                `);
            }
        });
    }
    
    // Attach change event handler to the multi-month checkbox
    $('#id_is_multi_month').on('change', function() {
        if($(this).is(':checked')) {
            // Get customer ID from the hidden field
            const customerId = $('input[name="customer"]').val();
            
            // If there's a customer ID, fetch unpaid months
            if (customerId) {
                // Refresh the unpaid months data
                refreshUnpaidMonths(customerId);
            } else {
                $('#unpaid-months-content').html(`
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        {% trans "No customer selected. Please select a customer first." %}
                    </div>
                `);
            }
            
            // Show the unpaid months section
            $('#unpaid-months-section').slideDown();
            
            // Hide the regular month/year selectors when in multi-month mode
            $('.form-group:has(#id_payment_for_month), .mb-3:has(#id_payment_for_month)').hide();
            $('.form-group:has(#id_payment_for_year), .mb-3:has(#id_payment_for_year)').hide();
            $('.single-month-info').hide();
            $('.multi-month-info').slideDown();
            
            // Also disable the fields to ensure they aren't submitted
            $('#id_payment_for_month').prop('disabled', true);
            $('#id_payment_for_year').prop('disabled', true);
            
            // Select all months by default (if any exist)
            $('input[name="selected_months"]').prop('checked', true);
        } else {
            // Hide unpaid months section
            $('#unpaid-months-section').slideUp();
            $('.multi-month-info').hide();
            $('.single-month-info').slideDown();
            
            // Show the regular month/year selectors when not in multi-month mode
            $('.form-group:has(#id_payment_for_month), .mb-3:has(#id_payment_for_month)').show();
            $('.form-group:has(#id_payment_for_year), .mb-3:has(#id_payment_for_year)').show();
            
            // Re-enable the fields
            $('#id_payment_for_month').prop('disabled', false);
            $('#id_payment_for_year').prop('disabled', false);
            
            // Unselect all months
            $('input[name="selected_months"]').prop('checked', false);
        }
    });
    
    // Add a refresh button to the unpaid months section
    $(document).on('click', '.refresh-unpaid-months', function(e) {
        e.preventDefault();
        // Try to get customer ID from data attribute first (for error cases), then fallback to input field
        const customerId = $(this).data('customer-id') || $('input[name="customer"]').val();
        if (customerId) {
            refreshUnpaidMonths(customerId);
        } else {
            // Show error message if no customer ID is found
            $('#unpaid-months-content').html(`
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i> 
                    {% trans "No customer selected. Please select a customer first." %}
                </div>
            `);
        }
    });
    
    // Add "Select All" button functionality
    $(document).on('click', '#select-all-months', function(e) {
        e.preventDefault();
        $('input[name="selected_months"]').prop('checked', true);
    });
    
    // Add "Deselect All" button functionality
    $(document).on('click', '#deselect-all-months', function(e) {
        e.preventDefault();
        $('input[name="selected_months"]').prop('checked', false);
    });
    
    // Handle initial state for editing multi-month payments
    {% if form.instance.pk and is_multi_month_payment %}
    // If this is an existing multi-month payment, show the existing allocations info
    $('.existing-allocations-info').show();
    
    // Pre-check the multi-month checkbox since this payment has allocations
    $('#id_is_multi_month').prop('checked', true);
    {% endif %}
    
    // Trigger the change event to set the initial state
    $('#id_is_multi_month').trigger('change');
});

// Add suggestion message when page loads
$(document).ready(function() {
    // If we have unpaid months, suggest multi-month mode
    if ($('input[name="selected_months"]').length > 0) {
        // Add a suggestion message
        $('<div class="alert alert-success mt-2" id="suggestion-alert">' +
          '<i class="fas fa-lightbulb"></i> ' +
          '{% trans "This customer has unpaid months. Consider using \"Distribute across multiple months\" option to clear older balances." %}' +
          '</div>').insertAfter($('#id_is_multi_month').closest('.form-group, .mb-3'));
    }
});
</script>
{% endblock %}